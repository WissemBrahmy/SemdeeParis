"use strict";

angular.module('semdeePortal.filters')
    .filter('toArray', function() {
        return function(items) {
            var filtered = [];
            angular.forEach(items, function(item) {
                filtered.push(item);
            });
            return filtered;
        };
    });


/**
 * Loading Bar New (Hau copy from bower_components\angular-loading-bar\build\loading-bar.js to fix:
 * hide Spinner and LoadingBar when call API updateCrawlInfos, this API run background )
 */
angular.module('cfp.loadingBar', [])
    .provider('cfpLoadingBar', function() {

        this.includeSpinner = true;
        this.includeBar = true;
        this.latencyThreshold = 100;
        this.startSize = 0.02;
        this.parentSelector = 'body';
        this.spinnerTemplate = '<div id="loading-bar-spinner"><div class="spinner-icon"></div></div>';
        this.loadingBarTemplate = '<div id="loading-bar"><div class="bar"><div class="peg"></div></div></div>';

        this.$get =
            ['$injector', '$document', '$timeout', '$rootScope',
                function ($injector, $document, $timeout, $rootScope) {
                    var $animate;
                    var $parentSelector = this.parentSelector,
                        loadingBarContainer = angular.element(this.loadingBarTemplate),
                        loadingBar = loadingBarContainer.find('div').eq(0),
                        spinner = angular.element(this.spinnerTemplate);

                    var incTimeout,
                        completeTimeout,
                        started = false,
                        status = 0;

                    var includeSpinner = this.includeSpinner;
                    var includeBar = this.includeBar;
                    var startSize = this.startSize;

                    /**
                     * Inserts the loading bar element into the dom, and sets it to 2%
                     */
                    function _start() {
                        if (!$animate) {
                            $animate = $injector.get('$animate');
                        }

                        var $parent = $document.find($parentSelector).eq(0);
                        $timeout.cancel(completeTimeout);

                        // do not continually broadcast the started event:
                        if (started) {
                            return;
                        }

                        $rootScope.$broadcast('cfpLoadingBar:started');
                        started = true;

                        if (includeBar) {
                            $animate.enter(loadingBarContainer, $parent, angular.element($parent[0].lastChild));
                        }

                        if (this.includeSpinner) {
                            $animate.enter(spinner, $parent, angular.element($parent[0].lastChild));

                            loadingBar.css('height','5px');

                        }
                        else{
                            loadingBar.css('height','0px');
                        }

                        _set(startSize);
                    }

                    /**
                     * Set the loading bar's width to a certain percent.
                     *
                     * @param n any value between 0 and 1
                     */
                    function _set(n) {
                        if (!started) {
                            return;
                        }
                        var pct = (n * 100) + '%';
                        loadingBar.css('width', pct);
                        status = n;

                        // increment loadingbar to give the illusion that there is always
                        // progress but make sure to cancel the previous timeouts so we don't
                        // have multiple incs running at the same time.
                        $timeout.cancel(incTimeout);
                        incTimeout = $timeout(function() {
                            _inc();
                        }, 250);
                    }

                    /**
                     * Increments the loading bar by a random amount
                     * but slows down as it progresses
                     */
                    function _inc() {
                        if (_status() >= 1) {
                            return;
                        }

                        var rnd = 0;

                        // TODO: do this mathmatically instead of through conditions

                        var stat = _status();
                        if (stat >= 0 && stat < 0.25) {
                            // Start out between 3 - 6% increments
                            rnd = (Math.random() * (5 - 3 + 1) + 3) / 100;
                        } else if (stat >= 0.25 && stat < 0.65) {
                            // increment between 0 - 3%
                            rnd = (Math.random() * 3) / 100;
                        } else if (stat >= 0.65 && stat < 0.9) {
                            // increment between 0 - 2%
                            rnd = (Math.random() * 2) / 100;
                        } else if (stat >= 0.9 && stat < 0.99) {
                            // finally, increment it .5 %
                            rnd = 0.005;
                        } else {
                            // after 99%, don't increment:
                            rnd = 0;
                        }

                        var pct = _status() + rnd;
                        _set(pct);
                    }

                    function _status() {
                        return status;
                    }

                    function _completeAnimation() {
                        status = 0;
                        started = false;
                    }

                    function _complete() {
                        if (!$animate) {
                            $animate = $injector.get('$animate');
                        }

                        $rootScope.$broadcast('cfpLoadingBar:completed');
                        _set(1);

                        $timeout.cancel(completeTimeout);

                        // Attempt to aggregate any start/complete calls within 500ms:
                        completeTimeout = $timeout(function() {
                            var promise = $animate.leave(loadingBarContainer, _completeAnimation);
                            if (promise && promise.then) {
                                promise.then(_completeAnimation);
                            }
                            $animate.leave(spinner);
                        }, 500);
                    }

                    return {
                        start            : _start,
                        set              : _set,
                        status           : _status,
                        inc              : _inc,
                        complete         : _complete,
                        includeSpinner   : this.includeSpinner,
                        latencyThreshold : this.latencyThreshold,
                        parentSelector   : this.parentSelector,
                        startSize        : this.startSize
                    };


                }];     //
    });       // wtf javascript. srsly